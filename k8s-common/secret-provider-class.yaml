apiVersion: secrets-store.csi.k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-kv-secrets
  namespace: prod
spec:
  provider: azure
  parameters:
    # This is for the old pod-identity, not Workload Identity
    usePodIdentity: "false"
    # This is for the node identity
    useVMManagedIdentity: "false"
    # The CLIENT ID of your User Assigned Identity from Terraform
    userAssignedIdentityID: "${azurerm_user_assigned_identity.app_identity.client_id}"
    keyvaultName: "${azurerm_key_vault.kv.name}"
    # The Tenant ID where the Key Vault is
    tenantId: "${azurerm_key_vault.kv.tenant_id}"
    objects: |
      array:
        - |
          objectName: redis-conn-string
          objectType: secret
        - |
          objectName: cosmos-conn-string
          objectType: secret
    
  secretObjects:
  - secretName: app-connection-secrets # The name of the resulting Kubernetes Secret
    type: Opaque
    data:
      # Key in the K8s Secret: Value in the Key Vault
      - key: REDIS_CONNECTION_STRING
        objectName: redis-conn-string
      - key: COSMOS_CONNECTION_STRING
        objectName: cosmos-conn-string